{% extends "base.html" %}

{% block title %}HDB Haven - Search{% endblock %}

{% block content %}
<div id="loader" class="lds-default" hidden><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
<div class="az-content">
  <div class="container">
    <div class="az-content-body">
      <h2 class="az-content-title">Comprehensive HDB Data</h2>
      <div class="az-content-label mg-b-5">Select your filters.</div>
      <p class="mg-b-20">Search for data on the type of flat you wish to purchase.</p>

      <hr class="mg-y-20">

      <div> <!-- Filters -->
        <div class="row row-sm">
          <div class="col-lg-6">
            <p class="mg-b-10">Date Range</p>
            <div class="row row-sm">
              <!-- From Date -->
              <div class="mg-b-20">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <div class="input-group-text">
                      From
                    </div>
                  </div>
                  <input id="date-from-input" type="text" class="form-control fc-datepicker" placeholder="MM/YYYY">
                </div>
              </div>
              <!-- To Date -->
              <div class="mg-b-20">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <div class="input-group-text">
                      To
                    </div>
                  </div>
                  <input id="date-to-input" type="text" class="form-control fc-datepicker" placeholder="MM/YYYY">
                </div>
              </div>
            </div> <!-- Row -->
          </div> <!-- Col -->
          <div class="col-lg-3">
            <p class="mg-b-10">Town</p>
            <select id="town-input" class="form-control select2">
              <option label="Choose one"></option>
              <option value="Sengkang">Sengkang</option>
              <option value="Geylang">Geylang</option>
              <option value="Punggol">Punggol</option>
              <option value="Hougang">Hougang</option>
              <option value="Pasir Ris">Pasir Ris</option>
              <option value="Woodlands">Woodlands</option>
              <option value="Yishun">Yishun</option>
              <option value="Tampines">Tampines</option>
              <option value="Jurong West">Jurong West</option>
              <option value="Jurong East">Jurong East</option>
              <option value="Bedok">Bedok</option>
              <option value="Choa Chu Kang">Choa Chu Kang</option>
              <option value="Toa Payoh">Toa Payoh</option>
              <option value="Bishan">Bishan</option>
              <option value="Ang Mo Kio">Ang Mo Kio</option>
              <option value="Serangoon">Serangoon</option>
              <option value="Bukit Batok">Bukit Batok</option>
              <option value="Bukit Merah">Bukit Merah</option>
              <option value="Bukit Panjang">Bukit Panjang</option>
              <option value="Bukit Timah">Bukit Timah</option>
              <option value="Kallang/Whampoa">Kallang/Whampoa</option>
              <option value="Sembawang">Sembawang</option>
              <option value="Clementi">Clementi</option>
              <option value="Queenstown">Queenstown</option>
              <option value="Central Area">Central Area</option>
              <option value="Marine Parade">Marine Parade</option>
            </select>
          </div> <!-- Col -->
          <div class="col-lg-3">
            <p class="mg-b-10">Flat Type</p>
            <select id="flat-type-input" class="form-control select2">
              <option label="Choose one"></option>
              <option value="Executive">Executive</option>
              <option value="5 Room">5 Room</option>
              <option value="4 Room">4 Room</option>
              <option value="3 Room">3 Room</option>
              <option value="2 Room">2 Room</option>
              <option value="1 Room">1 Room</option>
              <option value="Multi-Generation">Multi-Generation</option>
            </select>
          </div> <!-- Col -->
        </div> <!-- Row -->



        <!-- Range Pickers -->
        <div class="row row-sm">

          <div class="col-lg-6">
            <p class="mg-b-10">Floor Area Range</p>
            <input type="text" id="area-range-input" class="rangeslider1 range-control" data-extra-classes="irs-modern">
          </div> <!-- Col-->

          <div class="col-lg-6">
            <p class="mg-b-10">$ / m<sup>2</sup> Range</p>
            <input type="text" id="price-per-metre-range-input" class="rangeslider2 range-control"
              data-extra-classes="irs-modern">
          </div>
        </div> <!-- Row -->

        <div class="row row-sm">
          <div class="col-lg-12">
            <p class="mg-b-10">Resale Price Range</p>
            <input type="text" id="price-range-input" class="rangeslider1 range-control"
              data-extra-classes="irs-modern">
          </div> <!-- Col-->
        </div> <!-- Row -->

        <!-- Town Address-->
        <div class="row row-sm mg-y-20 wd-1000">
          <div class="col-lg">
            <p class="mg-b-10">Street Name</p>
            <input id="street-name-input" class="form-control" placeholder="Enter a street name" type="text">
          </div> <!-- Col-->
          <div class="col-lg">
            <p class="mg-b-10">Block</p>
            <input id="block-input" class="form-control" placeholder="Enter a block" type="text">
          </div> <!-- Col-->
          <div class="col-lg">
            <p class="mg-b-10">Storey Range</p>
            <div class="row row-sm">
              <div class="col-lg">
                <input disabled id="storey-from-input" class="form-control" placeholder="00" type="text">
              </div><!-- Col-->
              <span style="display:inline-block; padding-top:10px;">-</span>
              <div class="col-lg">
                <input disabled id="storey-to-input" class="form-control" placeholder="00" type="text">
              </div> <!-- Col-->
            </div> <!-- Row -->
          </div> <!-- Col-->
        </div> <!-- Row -->

        <div class="row row-sm mg-y-20 wd-600">
          <div class="col-lg">
            <p class="mg-b-10">Lease Commencement Date</p>
            <input disabled id="lease-date-input" class="form-control" placeholder="Enter a year" type="text">
          </div>
          <div class="col-lg">
            <p class="mg-b-10">Remaining Lease</p>
            <div class="row" style="flex-wrap: nowrap;">
              <div class="col-sm-6">
                <input disabled id="remlease-years-input" class="form-control" placeholder="Years" type="text">
              </div>
              <span style="display:inline-block; padding-top:10px;">&</span>
              <div class="col-sm-6">
                <input disabled id="remlease-months-input" class="form-control" placeholder="Months" type="text">
              </div>
            </div> <!-- Row for Years and Months-->
          </div> <!-- Col-->
        </div> <!-- Row -->

        <!-- Sort By -->
        <div class="row row-sm">
          <div class="col-lg-2">
            <p class="mg-b-10">Sort By</p>
            <select id="sort-by-input" class="form-control select2">
              <option label="Choose one"></option>
              <option value="month">Month</option>
              <option value="floor_area_sqm">Floor Area</option>
              <option value="resale_price">Resale Price</option>
              <option value="price_per_sq_metre">Price per metre square</option>
              <option value="remaining_lease">Remaining Lease</option>
            </select>
          </div> <!-- Col -->
          <div class="row mg-t-40">
            <div class="col-lg-5">
              <label class="rdiobox">
                <input name="sort-order" type="radio" value="1" class="rdio">
                <span>Ascending</span>
              </label>
            </div><!-- col-3 -->
            <div class="col-lg-5">
              <label class="rdiobox">
                <input name="sort-order" type="radio" value="0" class="rdio" checked>
                <span>Descending</span>
              </label>
            </div><!-- col-3 -->
          </div><!-- row -->
        </div> <!-- Row -->

        <!-- Action Buttons-->
        <div class="row row-sm mg-y-20">
          <div class="text-right ml-auto"><button id="reset-filters" class="btn btn-secondary" {% if hideActionButtons %} disabled {% endif %}>Reset All
              Filters</button></div>
          <div class="text-right"><button id="apply-filters" class="btn btn-primary" {% if hideActionButtons %} disabled {% endif %}>Apply 
            <span></span>
          </button></div>
        </div>

      </div> <!-- Filters End -->

      <hr class="mg-y-20">

      <!-- <div id="loading">Loading data, please wait...</div> -->
      <div class="table-responsive">
        <table id="main-table" class="hover stripe row-border dataTable" style="display: inline-block; overflow: auto;">
          <thead>
            <tr>
              <th style="position: sticky; top: 0; background-color: white;">Month</th>
              <th data-dt-order="disable" style="position: sticky; top: 0; background-color: white;">Town</th>
              <th style="position: sticky; top: 0; background-color: white;">Flat Type</th>
              <th style="position: sticky; top: 0; background-color: white;">Floor Area (m<sup>2</sup>)</th>
              <th style="position: sticky; top: 0; background-color: white;">Resale Price</th>
              <th style="position: sticky; top: 0; background-color: white;">$ / m<sup>2</sup></th>
              <th data-dt-order="disable" style="position: sticky; top: 0; background-color: white;">Street Name</th>
              <th data-dt-order="disable" style="position: sticky; top: 0; background-color: white;">Block</th>
              <th style="position: sticky; top: 0; background-color: white;">Storey Range</th>
              <!-- <th style="position: sticky; top: 0; background-color: white;">Flat Model</th> -->
              <th style="position: sticky; top: 0; background-color: white;">Lease Commence Date</th>
              <th style="position: sticky; top: 0; background-color: white;">Remaining Lease</th>
            </tr>
          </thead>
          <tbody>
            {% for row in data %}
            <tr>
              <td>{{ row["month"] }}</td>
              <td>{{ row["town"] }}</td>
              <td>{{ row["flat_type"] }}</td>
              <td value={{ row["floor_area_sqm"] }}>{{ row["floor_area_sqm"] }}</td>
              <!-- <td hidden>{{ row["resale_price"] }}</td> -->
              <td class="currency" value={{ row["resale_price"] }}>{{ row["f_resale_price"] }}</td>
              <!-- <td hidden>{{ row["price_per_sq_metre"] }}</td> -->
              <td class="currency" value={{ row["price_per_sq_metre"] }}>{{ row["f_price_per_sq_metre"] }}
              </td>
              <td>{{ row["street_name"] }}</td>
              <td>{{ row["block"] }}</td>
              <td>{{ row["storey_range"] }}</td>
              <!-- <td>{{ row["flat_model"] }}</td> -->
              <td>{{ row["lease_commence_date"] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div><!-- table-responsive -->

      <div class="ht-40"></div>

    </div><!-- az-content-body -->
  </div><!-- container -->
</div><!-- az-content -->

<script>
  // Datepicker
  $('.fc-datepicker').datepicker({
    showOtherMonths: true,
    selectOtherMonths: true,
    changeMonth: true,
    changeYear: true,
    showButtonPanel: true,
    dateFormat: 'MM yy',
    // minDate: "01 90",
    maxDate: 0,
    onClose: function (dateText, inst) {
      $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
    }
  });


  var $d1 = $('#price-range-input')
  var $d2 = $('#price-per-metre-range-input')
  var $d3 = $('#area-range-input')

  $d1.ionRangeSlider({
    type: 'double',
    grid: true,
    min: 0,
    max: 2000000,
    from: 0,
    to: 2000000,
    prefix: '$'
  });

  $d2.ionRangeSlider({
    type: 'double',
    grid: true,
    min: 0,
    max: 20000,
    from: 0,
    to: 20000,
    prefix: '$'
  });

  $d3.ionRangeSlider({
    type: 'double',
    grid: true,
    min: 0,
    max: 200,
    from: 0,
    to: 200,
    prefix: ''
  });


  let table = new DataTable('#main-table', {
    ordering: false,
    "processing": true,
    "serverSide": true,
    "ajax": "/get_data",
    "columns": [
      // { "data": "_id" },
      { "data": "month" },
      { "data": "town" },
      { "data": "flat_type" },
      { "data": "floor_area_sqm" },
      { "data": "f_resale_price" },
      { "data": "f_price_per_sq_metre" },
      { "data": "street_name" },
      { "data": "block" },
      { "data": "storey_range" },
      { "data": "lease_commence_date" },
      { "data": "remaining_lease" },
      // { "data": "flat_model" },
    ],
    columnDefs: [
      { width: '15%', targets: 1 },
      { width: '10%', targets: 3 },
      { width: '20%', targets: 6 },
      { width: '2%', targets: -2 },
    ],
    layout: {
      topStart: {
        buttons: [{ extend: 'colvis', text: 'Show/Hide Columns' }]
      },
      topEnd: null,
    },
    language: {
      emptyTable: 'Loading data...'
    },
    "pageLength": 15,
  });


  // Document Ready Function ----
  $(document).ready(function () {
    $('.select2').select2({
      placeholder: 'Choose one',
    });

    $('#reset-filters').click(function () {
      //console.log("reset clicked")
      //document.getElementById("filter-form").reset()

      form_controls = document.getElementsByClassName("form-control")
      range_controls = document.getElementsByClassName("range-control")

      // Reset text fields
      for (let i = 0; i < form_controls.length; i++) {
        form_controls[i].value = ""
      }

      // Reset placeholders for select class
      $('#town-input').val('').trigger('change')
      $('#flat-type-input').val('').trigger('change')
      $('#sort-by-input').val('').trigger('change')

      // Radiobuttons
      $(".rdio").prop('checked', true);

      // Reset the annoying ionrangesliders
      var d1_instance = $d1.data('ionRangeSlider')
      var d2_instance = $d2.data('ionRangeSlider')
      var d3_instance = $d3.data('ionRangeSlider')

      d1_instance.update({
        from: 0,
        to: 2000000,
      });

      d2_instance.update({
        from: 0,
        to: 20000,
      });

      d3_instance.update({
        from: 0,
        to: 200,
      });

      $.ajax({
        url: '/reset-filters',
        type: 'POST',
        success: function (response) {
          console.log(response.message);
          $('#main-table').DataTable().ajax.reload();
        },
        error: function (xhr, status, error) {
          console.error('Error clearing filters:', error);
        }
      });

    })

    $('#apply-filters').click(function () {
      console.log("apply clicked")
      document.getElementById("loader").hidden = false

      date = {
        "from": $('#date-from-input').val(),
        "to": $('#date-to-input').val()
      }
      floor_area = {
        "from": $('#area-range-input').data("from"),
        "to": $('#area-range-input').data("to")
      }
      resale_price = {
        "from": $('#price-range-input').data("from"),
        "to": $('#price-range-input').data("to")
      }
      price_per_m = {
        "from": $('#price-per-metre-range-input').data("from"),
        "to": $('#price-per-metre-range-input').data("to")
      }
      storey = {
        "from": document.getElementById("storey-from-input").value,
        "to": document.getElementById("storey-to-input").value
      }
      remaining_lease = {
        "years": $('#remlease-years-input').val(),
        "months": $('#remlease-months-input').val()
      }
      sort = {
        sortBy: document.getElementById("sort-by-input").value,
        order: document.querySelector('input[name="sort-order"]:checked').value
      }
      town = document.getElementById("town-input").value
      flat_type = document.getElementById("flat-type-input").value
      street_name = document.getElementById("street-name-input").value
      block = document.getElementById("block-input").value
      lease_date = document.getElementById("lease-date-input").value
      // # DF Cols:
      // # _id,month,town,flat_type,block,street_name,storey_range,
      // # floor_area_sqm,flat_model,lease_commence_date,resale_price,
      // # remaining_lease,price_per_sq_metre,f_resale_price,f_price_per_sq_metre
      data = {
        sort: sort,
        month: date,
        floor_area_sqm: floor_area,
        resale_price: resale_price,
        price_per_sq_metre: price_per_m,
        town: town,
        flat_type: flat_type,
        street_name: street_name,
        block: block,
        lease_commence_date: lease_date,
        remaining_lease: remaining_lease,
        storey_range: storey
      }

      $.ajax({
        url: "/filter-data",
        type: "POST",
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function (response) {
          if (response.success) {
            console.log("Success! ", response.data);
            window.scrollTo({ left: 0, top: document.body.scrollHeight, behavior: "smooth" });
            document.getElementById("loader").hidden = true
            
            var table = $('#main-table').DataTable();
            table.destroy();
            $('#main-table').DataTable({
              "ordering": false,
              "processing": true,
              "serverSide": true,
              "ajax": {
                "url": "/get_data",
                "type": "GET"
              },
              "columns": [
                { "data": "month" },
                { "data": "town" },
                { "data": "flat_type" },
                { "data": "floor_area_sqm" },
                { "data": "f_resale_price" },
                { "data": "f_price_per_sq_metre" },
                { "data": "street_name" },
                { "data": "block" },
                { "data": "storey_range" },
                { "data": "lease_commence_date" },
                { "data": "remaining_lease" },
              ],
              columnDefs: [
                { width: '15%', targets: 1 },
                { width: '10%', targets: 3 },
                { width: '20%', targets: 6 },
                { width: '2%', targets: -2 },
              ],
              layout: {
                topStart: {
                  buttons: [{ extend: 'colvis', text: 'Show/Hide Columns' }]
                },
                topEnd: null,
              },
              language: {
                emptyTable: 'Loading data...' // Change for when no records while searching
              },
              "pageLength": 15,
            });

          } else {
            console.warn("Validation error: ", response.errors);
          }
        },
        error: function (xhr, status, error) {
          // Handle error response (like a 400 status or any other non-2xx response)
          if (xhr.responseJSON && xhr.responseJSON.errors) {
            console.error('Error: ', xhr.responseJSON.errors);
          } else {
            console.error('Unknown Error: ', error);
          }
        }
      })
    })


    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('data_ready', function (msg) {
      console.log(msg.message);
      table.destroy();

      document.getElementById("reset-filters").removeAttribute("disabled");
      document.getElementById("apply-filters").removeAttribute("disabled");

      // Initialize DataTables after receiving the signal
      $('#main-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
          "url": "/get_data",
          "type": "GET"
        },
        "columns": [
          // { "data": "_id" },
          { "data": "month" },
          { "data": "town" },
          { "data": "flat_type" },
          { "data": "floor_area_sqm" },
          { "data": "f_resale_price" },
          { "data": "f_price_per_sq_metre" },
          { "data": "street_name" },
          { "data": "block" },
          { "data": "storey_range" },
          { "data": "lease_commence_date" },
          { "data": "remaining_lease" },
          // { "data": "flat_model" },
        ],
        columnDefs: [
          { width: '15%', targets: 1 },
          { width: '10%', targets: 3 },
          { width: '20%', targets: 6 },
          { width: '2%', targets: -2 },
        ],
        layout: {
          topStart: {
            buttons: [{ extend: 'colvis', text: 'Show/Hide Columns' }]
          },
          topEnd: null,
        },
        language: {
          emptyTable: 'Loading data...' // Change for when no records while searching
        },
        "pageLength": 15,
      });

      // Hide loading message and show table
      $('#loading').hide();
      $('#main-table').show();
    });

    // Auto display user's town area if logged in
    {% if user.is_authenticated %}
      $('#town-input').val("{{ user.district }}").trigger('change');
      $('#apply-filters').click();
    {% endif %}

  });


</script>
<style>
  .lds-default {
    /* change color here */
    color: #3366ff;
    position: absolute;
    left: 45%;
    top: 50%;
    z-index: 2;
    display: inline-block;
    width: 80px;
    height: 80px;
  }

  .lds-default,
  .lds-default div {
    box-sizing: border-box;
  }

  .lds-default div {
    position: absolute;
    width: 6.4px;
    height: 6.4px;
    background: currentColor;
    border-radius: 50%;
    animation: lds-default 1.2s linear infinite;
  }

  .lds-default div:nth-child(1) {
    animation-delay: 0s;
    top: 36.8px;
    left: 66.24px;
  }

  .lds-default div:nth-child(2) {
    animation-delay: -0.1s;
    top: 22.08px;
    left: 62.29579px;
  }

  .lds-default div:nth-child(3) {
    animation-delay: -0.2s;
    top: 11.30421px;
    left: 51.52px;
  }

  .lds-default div:nth-child(4) {
    animation-delay: -0.3s;
    top: 7.36px;
    left: 36.8px;
  }

  .lds-default div:nth-child(5) {
    animation-delay: -0.4s;
    top: 11.30421px;
    left: 22.08px;
  }

  .lds-default div:nth-child(6) {
    animation-delay: -0.5s;
    top: 22.08px;
    left: 11.30421px;
  }

  .lds-default div:nth-child(7) {
    animation-delay: -0.6s;
    top: 36.8px;
    left: 7.36px;
  }

  .lds-default div:nth-child(8) {
    animation-delay: -0.7s;
    top: 51.52px;
    left: 11.30421px;
  }

  .lds-default div:nth-child(9) {
    animation-delay: -0.8s;
    top: 62.29579px;
    left: 22.08px;
  }

  .lds-default div:nth-child(10) {
    animation-delay: -0.9s;
    top: 66.24px;
    left: 36.8px;
  }

  .lds-default div:nth-child(11) {
    animation-delay: -1s;
    top: 62.29579px;
    left: 51.52px;
  }

  .lds-default div:nth-child(12) {
    animation-delay: -1.1s;
    top: 51.52px;
    left: 62.29579px;
  }

  @keyframes lds-default {

    0%,
    20%,
    80%,
    100% {
      transform: scale(1);
    }

    50% {
      transform: scale(1.5);
    }
  }

  .container {
    max-width: 1550px
  }

  .ui-datepicker-calendar {
    display: none;
  }

  /* Styling for the dropdowns */
  .ui-datepicker .ui-datepicker-title {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    /* Space between dropdowns */
  }

  /* Styling for the previous and next arrows */
  .ui-datepicker .ui-datepicker-prev,
  .ui-datepicker .ui-datepicker-next {
    top: 0;
    /* Align arrows vertically with the dropdowns */
    width: 20px;
    height: 20px;
    margin: 0 10px;
    /* Space between the arrows and dropdowns */
  }

  .ui-datepicker-prev {
    left: 10px;
  }

  .ui-datepicker-next {
    right: 10px;
  }

  /* Dropdowns padding */
  .ui-datepicker .ui-datepicker-title select {
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  /* Adjust Done and Today button layout */
  .ui-datepicker-buttonpane {
    text-align: center;
    margin-top: 10px;
  }

  .ui-datepicker-buttonpane button {
    background-color: #007bff;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    border: none;
    font-size: 14px;
    margin: 0 5px;
    cursor: pointer;
  }

  .ui-datepicker-buttonpane button:hover {
    background-color: #0056b3;
  }
</style>
{% endblock %}